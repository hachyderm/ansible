---
- name: Verify
  hosts: molecule
  tasks:
    - name: Include default vars
      ansible.builtin.include_vars:
        dir: '{{ lookup("env", "MOLECULE_PROJECT_DIRECTORY") }}/defaults/'
        extensions:
          - 'yml'

    - name: Check binary file
      ansible.builtin.stat:
        path: /usr/local/bin/pgbackrest_exporter
      register: pgbackrest_exporter_binary

    - name: Verify binary file exists
      ansible.builtin.assert:
        that: pgbackrest_exporter_binary.stat.exists

    - name: Check the version
      ansible.builtin.command:
        cmd: pgbackrest_exporter --version
      changed_when: false
      register: pgbackrest_exporter_version_cmd

    - name: Verify the expected version
      ansible.builtin.assert:
        that: pgbackrest_exporter_version in pgbackrest_exporter_version_cmd.stderr_lines[0]

    - name: Check telemetry endpoint
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:9854/metrics"
        method: GET
        status_code: 200
